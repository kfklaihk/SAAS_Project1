{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///home/ubuntu/Downloads/Saas/lib/supabaseClient.ts"],"sourcesContent":["// /lib/supabaseClient.ts\r\nimport { createClient } from '@supabase/supabase-js';\r\n\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\r\nconst supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\r\n\r\nif (!supabaseUrl || !supabaseAnonKey) {\r\n  console.warn(\r\n    'Missing Supabase environment variables. Please set NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY in .env.local'\r\n  );\r\n}\r\n\r\nexport const supabase = createClient(\r\n  supabaseUrl || 'https://placeholder.supabase.co',\r\n  supabaseAnonKey || 'placeholder-key'\r\n);\r\n\r\n// For server-side service role operations (webhook updates):\r\nconst supabaseServiceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\r\n\r\nexport const supabaseAdmin = supabaseServiceRoleKey\r\n  ? createClient(supabaseUrl, supabaseServiceRoleKey)\r\n  : null;"],"names":[],"mappings":"AAAA,yBAAyB;;;;;;;AACzB;;AAEA,MAAM;AACN,MAAM;AAEN;;AAMO,MAAM,WAAW,IAAA,yMAAY,EAClC,eAAe,mCACf,mBAAmB;AAGrB,6DAA6D;AAC7D,MAAM,yBAAyB,QAAQ,GAAG,CAAC,yBAAyB;AAE7D,MAAM,gBAAgB,yBACzB,IAAA,yMAAY,EAAC,aAAa,0BAC1B"}},
    {"offset": {"line": 67, "column": 0}, "map": {"version":3,"sources":["file:///home/ubuntu/Downloads/Saas/app/api/ai/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport { supabaseAdmin } from '@/lib/supabaseClient';\r\n\r\nexport async function POST(req: Request) {\r\n  const { userId, title, transcript } = await req.json();\r\n\r\n  // Validate text length (max 5000 UTF-8 characters)\r\n  if (!transcript || typeof transcript !== 'string') {\r\n    return NextResponse.json({ error: 'Invalid transcript' }, { status: 400 });\r\n  }\r\n\r\n  const textLength = new TextEncoder().encode(transcript).length;\r\n  if (textLength > 5000) {\r\n    return NextResponse.json(\r\n      { error: 'Text exceeds 5000 UTF-8 character limit. Please reduce your input.' },\r\n      { status: 413 }\r\n    );\r\n  }\r\n\r\n  // Check plan & quota limits\r\n  const { data: profile } = await supabaseAdmin\r\n    .from('profiles')\r\n    .select('status')\r\n    .eq('id', userId)\r\n    .single();\r\n\r\n  const isActive = profile?.status === 'active';\r\n\r\n  // For free users: enforce 5 calls per 24 hours (reset at 00:00 +8 GMT)\r\n  if (!isActive) {\r\n    // Calculate today's date in +8 GMT timezone\r\n    const now = new Date();\r\n    const gmtPlus8 = new Date(now.getTime() + (8 * 60 * 60 * 1000));\r\n    const todayInGMT8 = gmtPlus8.toISOString().split('T')[0];\r\n\r\n    // Get or create usage record for today\r\n    const { data: usage, error: fetchErr } = await supabaseAdmin\r\n      .from('api_usage')\r\n      .select('call_count')\r\n      .eq('user_id', userId)\r\n      .eq('usage_date', todayInGMT8)\r\n      .single();\r\n\r\n    if (fetchErr && fetchErr.code !== 'PGRST116') {\r\n      // PGRST116 = no rows found, which is expected for new users\r\n      console.error('Error fetching usage:', fetchErr);\r\n      return NextResponse.json({ error: 'Failed to check quota' }, { status: 500 });\r\n    }\r\n\r\n    const currentCount = usage?.call_count ?? 0;\r\n\r\n    if (currentCount >= 5) {\r\n      return NextResponse.json(\r\n        { error: 'Free tier quota exceeded. You have 5 calls per 24 hours. Quota resets at 00:00 GMT+8 daily.' },\r\n        { status: 429 }\r\n      );\r\n    }\r\n\r\n    // Increment call count\r\n    if (usage) {\r\n      // Update existing record\r\n      await supabaseAdmin\r\n        .from('api_usage')\r\n        .update({ call_count: currentCount + 1, updated_at: new Date().toISOString() })\r\n        .eq('user_id', userId)\r\n        .eq('usage_date', todayInGMT8);\r\n    } else {\r\n      // Create new record\r\n      await supabaseAdmin\r\n        .from('api_usage')\r\n        .insert({\r\n          user_id: userId,\r\n          usage_date: todayInGMT8,\r\n          call_count: 1\r\n        });\r\n    }\r\n  }\r\n\r\n  // Build messages per DeepSeek chat-completions format\r\n  const messages = [\r\n    {\r\n      role: 'system',\r\n      content:\r\n        'You convert transcripts into structured summary. Return JSON giving insight of who, what , when , where, how and why in the summary.',\r\n    },\r\n    { role: 'user', content: transcript },\r\n  ];\r\n\r\n  const resp = await fetch(\r\n    `${process.env.DEEPSEEK_BASE_URL || 'https://api.deepseek.com'}/chat/completions`,\r\n    {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': `Bearer ${process.env.DEEPSEEK_API_KEY!}`,\r\n        'Content-Type': 'application/json',\r\n      },\r\n      body: JSON.stringify({\r\n        model: 'deepseek-chat',   // or 'deepseek-reasoner' for thinking mode\r\n        messages,\r\n        temperature: 0.2,\r\n        // If you want enforced JSON, DeepSeek follows OpenAI's response_format contract:\r\n        response_format: { type: 'json_object' },\r\n        stream: false,\r\n      }),\r\n    }\r\n  );\r\n\r\n  if (!resp.ok) {\r\n    const errText = await resp.text();\r\n    return NextResponse.json({ error: `DeepSeek error: ${errText}` }, { status: resp.status });\r\n  }\r\n\r\n  const data = await resp.json();\r\n  const content = data?.choices?.[0]?.message?.content ?? '';\r\n\r\n  let output;\r\n  try { output = JSON.parse(content); } catch { output = { summary: content }; }\r\n\r\n  const { data: doc } = await supabaseAdmin.from('documents').insert({\r\n    user_id: userId, title, input: { transcript }, output\r\n  }).select().single();\r\n\r\n  return NextResponse.json({ doc });\r\n}"],"names":[],"mappings":"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"}}]
}